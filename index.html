<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Load vs Paint Timing</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Image Load vs Paint Timing Demo</h1>
    <p>This demo shows the difference between when images finish loading and when they are painted to the screen.</p>
    
    <div class="controls">
        <label for="image-size">Image Size:</label>
        <select id="image-size">
            <option value="small">Small (faster)</option>
            <option value="medium" selected>Medium</option>
            <option value="large">Large (slower)</option>
        </select>
        
        <label for="image-type">Image Type:</label>
        <select id="image-type">
            <option value="standard">Standard</option>
            <option value="lowquality">Low Quality First</option>
        </select>
        
        <button id="reload-test">Run Test</button>
        <button id="full-reload">Full Page Reload</button>
        <button id="clear-cache">Clear Performance Cache</button>
    </div>
    
    <div class="product-container" id="product-container"></div>
    
    <div id="results">
        <h2>Timing Results</h2>
        <p>Click "Run Test" to start...</p>
    </div>
    
    <div id="page-metrics">
        <h2>Page Performance Metrics</h2>
        <div id="page-metrics-content">
            <p>Waiting for metrics...</p>
        </div>
    </div>
    
    <div class="info-section">
        <h3>Understanding Load vs. Paint Times</h3>
        <p><strong>Load Time:</strong> When the browser finishes downloading the image data and fires the JavaScript <code>load</code> event.</p>
        <p><strong>Paint Time:</strong> When the browser actually renders the image visibly on screen.</p>
        <p><strong>InViewport:</strong> When the image enters the user's viewport (visible area of the page).</p>
        <p>These times can differ because:</p>
        <ul>
            <li>The browser might batch rendering updates for performance</li>
            <li>The browser needs to decode image data after loading</li>
            <li>Other JavaScript might be blocking the main thread</li>
            <li>Layout and style calculations need to be performed</li>
            <li>Images might be outside the viewport when loaded</li>
        </ul>
        
        <h3>Page Performance Metrics</h3>
        <p><strong>First Contentful Paint (FCP):</strong> Marks when the first text or image is painted.</p>
        <p><strong>Largest Contentful Paint (LCP):</strong> Marks when the largest content element is painted.</p>
        <p><strong>Time to Interactive (TTI):</strong> When the page is fully interactive.</p>
        <p><strong>Navigation Timing API:</strong> Provides detailed timing information about the page load process.</p>
    </div>
    
    <!-- Configuration -->
    <script>
    /**
     * Configuration constants for the image loading demo
     */
    const CONFIG = {
        // Product data
        products: [
            {
                title: "Premium Product One",
                description: "High-quality product with amazing features.",
                price: "$129.99"
            },
            {
                title: "Deluxe Product Two",
                description: "Exclusive design with premium materials.",
                price: "$149.99"
            },
            {
                title: "Ultimate Product Three",
                description: "The best in its category, unmatched quality.",
                price: "$199.99"
            }
        ],
        
        // Image size configuration
        imageSizes: {
            small: "200/150",
            medium: "600/400",
            large: "1200/800"
        },
        
        // Low quality image size
        lqipSize: "50/30",
        
        // Performance thresholds (in milliseconds)
        performance: {
            fcp: {
                good: 1800,
                poor: 3000
            },
            lcp: {
                good: 2500,
                poor: 4000
            },
            loadToPaint: {
                fast: 50,
                slow: 300
            }
        },
        
        // IntersectionObserver configuration
        observer: {
            threshold: 0.1,
            rootMargin: "0px"
        }
    };
    </script>
    
    <!-- Load the modules -->
    <script src="metrics.js"></script>
    <script src="imageLoader.js"></script>
    
    <!-- Initialize the application -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Wait slightly to ensure scripts are loaded
        setTimeout(function() {
            // Initialize page metrics tracking
            if (window.PageMetricsTracker) {
                window.pageMetricsTracker = new window.PageMetricsTracker();
                window.pageMetricsTracker.init();
            } else {
                console.error("PageMetricsTracker not found! Check that metrics.js is loaded correctly.");
            }
            
            // Create image loader instance
            if (window.ImageLoader) {
                const imageLoader = new window.ImageLoader();
                
                // Event listener for the reload button
                const reloadButton = document.getElementById('reload-test');
                reloadButton.addEventListener('click', () => {
                    // Show loading indicator
                    const resultElement = document.getElementById('results');
                    if (resultElement) {
                        resultElement.innerHTML = '<h2>Timing Results</h2><p>Resetting page state...</p>';
                    }
                    
                    // First, force any pending events to complete
                    setTimeout(() => {
                        // Reset metrics for a new test with a more thorough approach
                        if (window.pageMetricsTracker) {
                            window.pageMetricsTracker.reset();
                        }
                        
                        // Load images with current settings - will do a deeper reset
                        imageLoader.loadImages();
                    }, 100);
                });
                
                // Event listener for the full reload button
                const fullReloadButton = document.getElementById('full-reload');
                if (fullReloadButton) {
                    fullReloadButton.addEventListener('click', () => {
                        // Store current settings in session storage to preserve them
                        sessionStorage.setItem('savedImageSize', imageLoader.imageSize.value || 'medium');
                        sessionStorage.setItem('savedImageType', imageLoader.imageType.value || 'standard');
                        
                        // Force a complete page reload, bypassing the cache
                        window.location.reload(true);
                    });
                }
                
                // Event listener for the clear cache button
                const clearCacheButton = document.getElementById('clear-cache');
                clearCacheButton.addEventListener('click', () => {
                    // Clear performance entries if browser supports it
                    if (window.pageMetricsTracker && typeof window.pageMetricsTracker.clearPerformanceEntries === 'function') {
                        window.pageMetricsTracker.clearPerformanceEntries();
                    }
                    
                    // Reset metrics tracker
                    if (window.pageMetricsTracker && typeof window.pageMetricsTracker.reset === 'function') {
                        window.pageMetricsTracker.reset();
                    }
                    
                    alert('Performance cache cleared! Run a new test to see updated metrics.');
                });
                
                // Check for saved settings from previous session
                const savedSize = sessionStorage.getItem('savedImageSize');
                const savedType = sessionStorage.getItem('savedImageType');
                
                if (savedSize && document.getElementById('image-size')) {
                    document.getElementById('image-size').value = savedSize;
                }
                
                if (savedType && document.getElementById('image-type')) {
                    document.getElementById('image-type').value = savedType;
                }
                
                // Clear saved settings now that we've used them
                sessionStorage.removeItem('savedImageSize');
                sessionStorage.removeItem('savedImageType');
                
                // Initial load
                imageLoader.loadImages();
            } else {
                console.error("ImageLoader not found! Check that imageLoader.js is loaded correctly.");
            }
        }, 300); // Increased delay to ensure scripts are fully loaded
    });
    </script>
</body>
</html>